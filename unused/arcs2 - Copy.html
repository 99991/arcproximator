<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title></title>
</head>
<body>
<!--  style="margin:0; padding: 0; top:0; left:0; position:absolute;" -->
<canvas id="canvas" width="512" height="512"></canvas>
<canvas id="canvas2" width="256" height="256"></canvas>
<script src="util.js"></script>
<script src="vector.js"></script>
<script src="draw.js"></script>
<script src="intersection.js"></script>
<script src="arc.js"></script>
<script src="segment.js"></script>
<script src="triangle.js"></script>
<script src="split.js"></script>
<script>

var canvas2 = document.getElementById("canvas2")
var context2 = canvas2.getContext("2d");

var nx = canvas.width
var ny = canvas.height
var imageData = context.createImageData(nx, ny)
var abgr = imageData.data

var nx2 = canvas2.width
var ny2 = canvas2.height
var imageData2 = context2.createImageData(nx2, ny2)
var abgr2 = imageData2.data

var arcIsCCW = true
var a = [1337, 666]
var b = [666, 1234]

function countArcIntersections(x, y, arc){
	var p = [x, y]
	var clockwise = !arc.counterclockwise
	var a = arc.a
	var b = arc.b
	
	// cw case is same as ccw case with 'a' and 'b' swapped
	if (clockwise){
		var temp = a
		a = b
		b = temp
	}
	
	var center = arc.center
	var radius = arc.radius
	var ax = a[0]
	var ay = a[1]
	var bx = b[0]
	var by = b[1]
	var cx = center[0]
	var cy = center[1]
	
	// bounding box of circle
	var left = cx - radius
	var right = cx + radius
	var bottom = cy - radius
	var top = cy + radius
	
	// if ray does not intersect bounding box
	if (y <= bottom || y >= top || x > right) return 0
	
	var outside = dist2(p, center) >= radius*radius
	
	// if ray does not intersect circle
	if (outside && x > cx) return 0
	
	var below = y <  Math.min(ay, by)
	var above = y > Math.max(ay, by)
	var between = !below && !above
	
	if (ay < by){
		// 'b' above 'a'
		
		if (ax <= cx && bx <= cx){
			return (!between && outside) ? 2 : 1
		}
		if (ax > cx && bx > cx) return between ? 1 : 0
		if (ax > cx && bx <= cx){
			if (above) return outside ? 2 : 1
			if (below) return 0
			return 1
		}
		if (ax <= cx && bx > cx){
			if (above) return 0
			if (below) return outside ? 2 : 1
			return 1
		}
	}else{
		// 'a' above 'b'
		
		if (ax <= cx && bx <= cx) return (between && outside) ? 1 : 0
		if (ax > cx && bx > cx) return between ? (outside ? 1 : 0) : (outside ? 2 : 1)
		if (ax > cx && bx <= cx){
			if (above) return outside ? 2 : 1
			if (below) return 0
			return outside ? 1 : 0
		}
		if (ax <= cx && bx > cx){
			if (above) return 0
			if (below) return outside ? 2 : 1
			return outside ? 1 : 0
		}
	}
}

function isInPolygon(x, y, points){
	var nIntersections = 0
	var n = points.length;
	var a = points[n - 1]
	var inside = false
	for (var i = 0; i < n; i++){
		var b = points[i]
		var aNext = b
		
		// make 'a' the lower point
		if (a[1] > b[1]){
			var temp = a
			a = b
			b = temp
		}
		
		var ax = a[0]
		var ay = a[1]
		var bx = b[0]
		var by = b[1]
		
		// ignore horizontal line segments and intersections in 'b'
		if (ay != by && ay <= y && y < by){
			inside ^= (x - ax)*(by - ay) - (y - ay)*(bx - ax) <= 0
		}
		
		a = aNext
	}
	return inside
}

var points = new Array(5)
for (var i = 0; i < points.length; i++){
	var x = Math.random()*nx|0
	var y = Math.random()*ny|0
	points[i] = [x, y]
}

function isInArcs(x, y, arcs){
	var nIntersections = 0
	for (var i = 0; i < arcs.length; i++){
		nIntersections += countArcIntersections(x, y, arcs[i])
	}
	return nIntersections % 2 == 1
}

function redraw(){
	context.clearRect(0, 0, canvas.width, canvas.height)
	context2.clearRect(0, 0, canvas2.width, canvas2.height)
	// y-axis should be up, not down
	context.setTransform(1, 0, 0, -1, 0, canvas.height)
	context2.setTransform(1, 0, 0, -1, 0, canvas2.height)
	context.lineWidth = 2
		
	if (0){
		
		var i = 0
		for (var y = 0; y < ny; y++){
			for (var x = 0; x < nx; x++){
				
				if (isInPolygon(x, ny - 1 - y, points)){
					abgr[i+0] = 0x55
					abgr[i+1] = 0x55
					abgr[i+2] = 0x55
				}else{
					abgr[i+0] = 0
					abgr[i+1] = 0
					abgr[i+2] = 0
				}
				abgr[i+3] = 0xff
				i += 4
			}
		}
		
		context2.putImageData(imageData, 0, 0)
		
		context2.strokeStyle = "green"
		//drawPolygon(points)
	}
	
	if (1){
		var radius = 100
		var center = [200, 300]
		a = add(center, scale(sub(a, center), radius))
		b = add(center, scale(sub(b, center), radius))
		a[0] = Math.round(a[0])
		a[1] = Math.round(a[1])
		b[0] = Math.round(b[0])
		b[1] = Math.round(b[1])
		
		var arc = new Arc(center, radius, a, b, arcIsCCW)
		
		var i = 0
		for (var y = 0; y < ny; y++){
			for (var x = 0; x < nx; x++){
				
				var n = countArcIntersections(x, ny - 1 - y, arc)
				
				switch (n){
					case 0:
						abgr[i+0] = 0
						abgr[i+1] = 0
						abgr[i+2] = 0
					break
					case 1:
						abgr[i+0] = 0
						abgr[i+1] = 0xff
						abgr[i+2] = 0
					break
					case 2:
						abgr[i+0] = 0
						abgr[i+1] = 0
						abgr[i+2] = 0xff
					break
					default:
						abgr[i+0] = 0x55
						abgr[i+1] = 0x55
						abgr[i+2] = 0x55
					break
					
				}
				abgr[i+3] = 0xff
				i += 4
			}
		}
		
		context.putImageData(imageData, 0, 0)
		
		context.strokeStyle = "yellow"
		arc.draw(context)
		
		context.font = "50px Arial"
		context.fillStyle = "black"
		context.strokeStyle = "white"
		
		
		
		if (arc.clockwise){
			writeOutlined("a", arc.b)
			writeOutlined("b", arc.a)
		}else{
			writeOutlined("a", arc.a)
			writeOutlined("b", arc.b)
		}
		
		if (0){		
			context.lineWidth = 1
			context.strokeStyle = "red"
			new Segment(add(arc.b, [0, -0.5]), add(arc.b, [1000, -0.5])).draw(context)
			context.lineWidth = 2
		}
		
		var center0 = [100, 50]
		var radius0 = 25
		var center1 = add(center0, [radius0, radius0])
		var center2 = add(center1, [radius0, radius0])
		var center3 = add(center2, [radius0, radius0])
		var center4 = add(center3, [-radius0, radius0])
		var center5 = add(center4, [-2*radius0, 0])
		var center6 = add(center5, [-radius0, -radius0])
		var center7 = add(center6, [0, -2*radius0])
		
		var arcs = [
			new Arc(center0, radius0, add(center0, [radius0, 0]), add(center0, [0, radius0]), false),
			new Arc(center1, radius0, add(center1, [0, -radius0]), add(center1, [0, radius0]), true),
			new Arc(center2, radius0, add(center2, [-radius0, 0]), add(center2, [0, radius0]), false),
			new Arc(center3, radius0, add(center3, [-radius0, 0]), add(center3, [radius0, 0]), true),
			new Arc(center3, radius0, add(center3, [-radius0, 0]), add(center3, [0, radius0]), true),
			new Arc(center4, radius0, add(center4, [radius0, 0]), add(center4, [-radius0, 0]), true),
			new Arc(center5, radius0, add(center5, [radius0, 0]), add(center5, [-radius0, 0]), false),
			new Arc(center6, radius0, add(center6, [0, radius0]), add(center6, [0, -radius0]), true),
			new Arc(center7, radius0, add(center7, [0, radius0]), add(center7, [radius0, 0]), false),
		]
		
		var i = 0
		for (var y = 0; y < ny2; y++){
			for (var x = 0; x < nx2; x++){
				
				if (isInArcs(x, ny2 - 1 - y, arcs)){
					abgr2[i+0] = 0x77
					abgr2[i+1] = 0x77
					abgr2[i+2] = 0x77
				}else{
					abgr2[i+0] = 0x33
					abgr2[i+1] = 0x33
					abgr2[i+2] = 0x33
				}
				abgr2[i+3] = 0xff
				i += 4
			}
		}
		
		context2.putImageData(imageData2, 0, 0)
		
		for (var i = 0; i < arcs.length; i++){
			context2.strokeStyle = colors[i % colors.length]
			arcs[i].draw(context2)
		}
	}
	
	/*
	if (1){
		// test splitting functions
		var curves = [
			new Arc(mouse, 100, 0.5, 1.5),
			new Arc([256, 256], 150, -0.3, -0.9, true),
			new Arc([300, 400], 125, -0.3, -1.9),
			new Segment([100, 350], [450, 300]),
			new Segment([150, 50], [450, 500]),
		]
		
		curves = splitAtIntersections(curves)
		curves = splitLongArcs(curves)
		curves = splitIntersectingArcs(curves)
		
		for (var i = 0; i < curves.length; i++){
			context.strokeStyle = colors[i % colors.length]
			var curve = curves[i]
			curve.draw()
			var middle = curve.middle()
			write(i, middle)
		}
	}
	*/
}

function resize(){
	//canvas.width = window.innerWidth
	//canvas.height = window.innerHeight
	redraw()
}

resize()

window.onresize = resize

window.onmousedown = function(e){
	var x = e.clientX
	var y = canvas.height - e.clientY - 1
	mouse = [x, y]
	
	if (e.buttons & 4){
		arcIsCCW = !arcIsCCW
	}
	redraw()
}

window.onmousemove = function(e){
	var x = e.clientX
	var y = canvas.height - e.clientY - 1
	mouse = [x, y]
	
	if (e.buttons & 1){
		if (dist2(mouse, a) < dist2(mouse, b)){
			a = [x, y]
		}else{
			b = [x, y]
		}
		
		var closest = points[0]
		for (var i = 1; i < points.length; i++){
			var point = points[i]
			if (dist2(mouse, point) < dist2(mouse, closest)){
				closest = point
			}
		}
		closest[0] = x
		closest[1] = y
	}
	
	redraw()
}

</script>
</body>
</html>
